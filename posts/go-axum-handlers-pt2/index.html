<!doctype html><html lang=en><head><title>Axum-style Magic Handler Functions in Go, Part 2 :: kubuzetto's blog</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="We continue with our aimless pursuit of a boilerplate-free Go. Now with more structs!"><meta name=keywords content="axum,go,http"><meta name=robots content="noodp"><link rel=canonical href=/posts/go-axum-handlers-pt2/><link rel=stylesheet href=/styles.css><link rel="shortcut icon" href=/img/theme-colors/orange.png><link rel=apple-touch-icon href=/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Axum-style Magic Handler Functions in Go, Part 2"><meta property="og:description" content="We continue with our aimless pursuit of a boilerplate-free Go. Now with more structs!"><meta property="og:url" content="/posts/go-axum-handlers-pt2/"><meta property="og:site_name" content="kubuzetto's blog"><meta property="og:image" content="/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2024-12-27 23:21:56 +0300 +0300"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>kubuzetto's blog</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;â–¾</li><li><ul class=menu__dropdown><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/pages/about/>About</a></li><li><a href=/tags>Tags</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/pages/about/>About</a></li><li><a href=/tags>Tags</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/posts/go-axum-handlers-pt2/>Axum-style Magic Handler Functions in Go, Part 2</a></h1><div class=post-meta><time class=post-date>2024-12-27</time></div><div class=table-of-contents><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a><ul><li><a href=#a-way-out>A way out</a></li></ul></li><li><a href=#going-through-the-motions>Going through the motions</a><ul><li><a href=#accessing-the-field>Accessing the field</a></li><li><a href=#newat>NewAt</a></li></ul></li><li><a href=#generics-out>Generics out</a></li><li><a href=#implementing-the-extractors>Implementing the Extractors</a></li><li><a href=#finalizing-resources>Finalizing resources</a></li><li><a href=#final-notes>Final notes</a></li></ul></nav></div><div class=post-content><div><h2 id=introduction>Introduction<a href=#introduction class=hanchor arialabel=Anchor>&#8983;</a></h2><p>In the <a href=/posts/go-axum-handlers/>first part</a> of this blog post, we tried to replicate the
<a href=https://github.com/alexpusch/rust-magic-patterns/tree/master/axum-style-magic-function-param>magic of axum</a>
in Go. In the end, we had endpoint handlers that looked like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>createUser</span>(<span style=color:#a6e22e>l</span> <span style=color:#a6e22e>Logger</span>, <span style=color:#a6e22e>payload</span> <span style=color:#a6e22e>JSON</span>[<span style=color:#a6e22e>CreateUser</span>]) (<span style=color:#a6e22e>response</span> <span style=color:#a6e22e>JSON</span>[<span style=color:#a6e22e>User</span>], <span style=color:#a6e22e>_</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>V</span> = <span style=color:#a6e22e>User</span>{<span style=color:#a6e22e>ID</span>: <span style=color:#ae81ff>1337</span>, <span style=color:#a6e22e>Username</span>: <span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>V</span>.<span style=color:#a6e22e>Username</span>}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;created&#34;</span>, <span style=color:#e6db74>&#34;user&#34;</span>, <span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>V</span>.<span style=color:#a6e22e>Username</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I recommend you read that one first.</p><p>Today, we continue with our aimless pursuit of a boilerplate-free Go. Now with more structs!</p><p>Here&rsquo;s the thing: In our previous implementation, we had to invoke the function using reflection, because our handlers
can have any number of arguments. But reflection has some overhead; especially function calls this way tend to be
<a href=https://github.com/golang/go/issues/7818>pretty slow</a>.</p><h3 id=a-way-out>A way out<a href=#a-way-out class=hanchor arialabel=Anchor>&#8983;</a></h3><p>I&rsquo;m thinking, maybe we can represent all function arguments as <strong>fields of one struct</strong>. Then our handler function
signature will be:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handler</span>[<span style=color:#a6e22e>Args</span>, <span style=color:#a6e22e>Output</span> <span style=color:#a6e22e>any</span>](<span style=color:#a6e22e>a</span> <span style=color:#a6e22e>Args</span>)(<span style=color:#a6e22e>Output</span>, <span style=color:#66d9ef>error</span>)
</span></span></code></pre></div><p>The previous example will end up looking like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>createUser</span>(<span style=color:#a6e22e>p</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Logger</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>JSON</span>[<span style=color:#a6e22e>CreateUser</span>]
</span></span><span style=display:flex><span>}) (<span style=color:#a6e22e>User</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;created&#34;</span>, <span style=color:#e6db74>&#34;user&#34;</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>V</span>.<span style=color:#a6e22e>Username</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>User</span>{<span style=color:#a6e22e>ID</span>: <span style=color:#ae81ff>1337</span>, <span style=color:#a6e22e>Username</span>: <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>V</span>.<span style=color:#a6e22e>Username</span>}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This signature has the big advantage that our <code>Handler</code> wrapper function can now represent the function as a
function type, instead of falling back to <code>any</code>. Sure, the input type must be filled using reflection again;
but the function invocation itself will be regular Go code. So let&rsquo;s start!</p><h2 id=going-through-the-motions>Going through the motions<a href=#going-through-the-motions class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Once again, we create a function that extracts the inputs. Note that this time we don&rsquo;t have to reflectively work
on the outputs; because we settled on the function signature - one input struct, two outputs. <code>Output</code> is treated
as <code>any</code> in the function body, but is generic in the signature; that is for calling site readability and convenience.</p><ol><li>Prepare a function to extract function inputs from the request; and into the input struct.</li><li>During handler calls; invoke this function. This time we return the constructed struct.</li><li>Handling the output of the function is the same as the previous version, I won&rsquo;t get into details here.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Handler</span>[<span style=color:#a6e22e>Args</span>, <span style=color:#a6e22e>Output</span> <span style=color:#a6e22e>any</span>](<span style=color:#a6e22e>handler</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>Args</span>) (<span style=color:#a6e22e>Output</span>, <span style=color:#66d9ef>error</span>)) <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandlerFunc</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>extractInputs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>toExtractorFn</span>[<span style=color:#a6e22e>Args</span>]() <span style=color:#75715e>// 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>out</span> <span style=color:#a6e22e>any</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>args</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>extractInputs</span>(<span style=color:#a6e22e>r</span>) <span style=color:#75715e>// 2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>out</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>args</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 3
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>WriteResponse</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>out</span>)
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>writeErrResp</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>All type checks and reflection shenanigans are on the input argument this time; so we don&rsquo;t have reflection calls here.
Let&rsquo;s get into <code>toExtractorFn</code>. First things first, we must check that <code>Args</code> is a struct:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PanicReasonHandlerExpectsAStruct</span> = <span style=color:#e6db74>&#34;Handler argument should be a struct&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>toExtractorFn</span>[<span style=color:#a6e22e>Args</span> <span style=color:#a6e22e>any</span>]() <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) (<span style=color:#a6e22e>Args</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>argType</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>TypeFor</span>[<span style=color:#a6e22e>Args</span>]()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>argType</span>.<span style=color:#a6e22e>Kind</span>() <span style=color:#f92672>!=</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Struct</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>PanicReasonHandlerExpectsAStruct</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span></code></pre></div><p>Familiar stuff. This time, we will iterate the fields of <code>Args</code>; each field should implement an
<code>Extractor</code> interface like before.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>numFields</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>argType</span>.<span style=color:#a6e22e>NumField</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>funcs</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>Args</span>) <span style=color:#66d9ef>error</span>, <span style=color:#a6e22e>numFields</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>numFields</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>field</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>argType</span>.<span style=color:#a6e22e>Field</span>(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>PointerTo</span>(<span style=color:#a6e22e>field</span>.<span style=color:#a6e22e>Type</span>).<span style=color:#a6e22e>Implements</span>(<span style=color:#a6e22e>extType</span>) {
</span></span><span style=display:flex><span>            panic(<span style=color:#a6e22e>PanicReasonUnknownFieldType</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>funcs</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>extractFieldOfType</span>[<span style=color:#a6e22e>Args</span>](<span style=color:#a6e22e>field</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>field</span>.<span style=color:#a6e22e>Offset</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>extType</span> = <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>TypeFor</span>[<span style=color:#a6e22e>Extractor</span>]()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PanicReasonUnknownFieldType</span> = <span style=color:#e6db74>&#34;Cannot determine how to extract handler argument field&#34;</span>
</span></span></code></pre></div><p>This will give us an array of functions that extract the arguments from the request.
Note how I use <code>reflect.PointerTo</code> here; that&rsquo;s because I want the types implementing the <code>Extractor</code>
interface to have <em>pointer receivers</em>. Our previous implementation also supported value receivers,
this time I don&rsquo;t bother with that case. The reason will be clear very soon.</p><p>What arguments should these functions receive? Clearly, we should pass <code>*http.Request</code>,
and also, uh, <em>something</em> for the field to extract. We can&rsquo;t explicitly type each argument here obviously;
so all we can do is pass the whole <code>args</code> struct&rsquo;s type, and that&rsquo;s what we do.</p><p>Next step is returning the function that extracts <em>all</em> fields at once:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) (<span style=color:#a6e22e>args</span> <span style=color:#a6e22e>Args</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>numFields</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>funcs</span>[<span style=color:#a6e22e>i</span>](<span style=color:#a6e22e>r</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>WithStatusCode</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next, our <code>extractFieldOfType</code> function should be able to operate on the given field of <code>Args</code>.</p><h3 id=accessing-the-field>Accessing the field<a href=#accessing-the-field class=hanchor arialabel=Anchor>&#8983;</a></h3><p>So far we have been fast forwarding similar parts. Now is the time to stop and think.</p><p><code>argType.Field(i)</code> gave us <code>reflect.StructField</code>; which has the field&rsquo;s <code>reflect.Type</code>,
as well as the <em>memory offset</em> from the base of <code>Args</code>. We want to end up with a reference to the field,
and cast that reference to the <code>Extractor</code> interface; so that we have some methods to call.</p><p>First things first, let&rsquo;s get the field&rsquo;s absolute memory address:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>extractFieldOfType</span>[<span style=color:#a6e22e>Args</span> <span style=color:#a6e22e>any</span>](<span style=color:#a6e22e>fieldType</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>fieldOffset</span> <span style=color:#66d9ef>uintptr</span>) <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>Args</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>argBase</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Args</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fieldPtr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>argBase</span>), <span style=color:#a6e22e>fieldOffset</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ... ??
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Ok, now what? We have an <code>unsafe.Pointer</code> that points to the field to extract. If we knew the field&rsquo;s type as a
<em>generic</em> type, like <code>T</code>, we could have done</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>field</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>any</span>((<span style=color:#f92672>*</span><span style=color:#a6e22e>T</span>)(<span style=color:#a6e22e>fieldPtr</span>)).(<span style=color:#a6e22e>Extractor</span>)
</span></span></code></pre></div><p>and proceed from there.
But we don&rsquo;t know the field&rsquo;s type like this! All we have is <code>reflect.Type</code>!
How can we get an <code>any</code> from <code>unsafe.Pointer</code>?</p><p>Wait.</p><h3 id=newat>NewAt<a href=#newat class=hanchor arialabel=Anchor>&#8983;</a></h3><p>The <code>reflect</code> package <em>does</em> have a gem for us.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// in reflect/value.go
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// NewAt returns a Value representing a pointer to a value of the
</span></span></span><span style=display:flex><span><span style=color:#75715e>// specified type, using p as that pointer.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewAt</span>(<span style=color:#a6e22e>typ</span> <span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>p</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) <span style=color:#a6e22e>Value</span> { <span style=color:#f92672>...</span> }
</span></span></code></pre></div><p>We know that <code>fieldPtr</code> is pointing to a memory region that is <code>T</code>-sized for field of type <code>T</code>.
Why not point a <code>Value</code> for type <code>T</code> to this address? We can do the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// pointer to the field
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>fieldPtr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>argBase</span>), <span style=color:#a6e22e>fieldOffset</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>// initialize field at address fieldPtr; get a reflect.Value; turn it into any
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>field</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>NewAt</span>(<span style=color:#a6e22e>fieldType</span>, <span style=color:#a6e22e>fieldPtr</span>).<span style=color:#a6e22e>Interface</span>()
</span></span><span style=display:flex><span><span style=color:#75715e>// cast to our interface and get to work
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>return</span> <span style=color:#a6e22e>field</span>.(<span style=color:#a6e22e>Extractor</span>).<span style=color:#a6e22e>Extract</span>(<span style=color:#a6e22e>r</span>)
</span></span></code></pre></div><p>This has an <strong>amazing</strong> side effect in terms of ergonomics:
In our previous implementation, our <code>Extractor</code>s were written a bit weirdly;
in that it had to work on a zero value to return a new result, wrapped into a <code>reflect.Value</code>.
They weren&rsquo;t like member functions, but had to behave like functions defined on the type itself.</p><p><strong>This time we are calling the member function of an <em>instantiated</em> field</strong>.
That means the method can directly modify its receiver value like normal Go code!</p><p>So our <code>Extractor</code> interface becomes very simply:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Extractor</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Extract</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=generics-out>Generics out<a href=#generics-out class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Before we start implementing <code>Extractor</code>s&mldr; Since we didn&rsquo;t know how the function <code>extractFieldOfType</code> would shape,
we passed an <code>*Args</code> argument here. But this helper function does not have to be generic on <code>Args</code>; which would
increase compilation times and binary size. Instead, since we immediately cast <code>&amp;args</code> into an <code>unsafe.Pointer</code>, we
can directly pass an <code>unsafe.Pointer</code> here.</p><p>In fact, even our <code>extractorFor</code> function does not have to be generic. We are already operating on the <code>reflect.Type</code>
of <code>Args</code>; for the one-time preparation; and for the handler we only need the <code>unsafe.Pointer</code>. Let&rsquo;s rewrite that
as well so that the little use of generics is in the very top-level <code>Handler</code> function.</p><p>Here is the entire code so far (except unchanged helper functions like <code>WriteResponse</code> from before):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Extractor</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Extract</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>extType</span> = <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>TypeFor</span>[<span style=color:#a6e22e>Extractor</span>]()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PanicReasonHandlerExpectsAStruct</span> = <span style=color:#e6db74>&#34;Handler argument should be a struct&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PanicReasonUnknownFieldType</span> = <span style=color:#e6db74>&#34;Cannot determine how to extract handler argument field&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Handler is generic because we want to strongly type the inner handler function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Handler</span>[<span style=color:#a6e22e>Args</span>, <span style=color:#a6e22e>Output</span> <span style=color:#a6e22e>any</span>](<span style=color:#a6e22e>handler</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>Args</span>) (<span style=color:#a6e22e>Output</span>, <span style=color:#66d9ef>error</span>)) <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandlerFunc</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Preparation is done using reflection ONLY
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>extractInputs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>extractorFor</span>(<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>TypeFor</span>[<span style=color:#a6e22e>Args</span>]())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>out</span> <span style=color:#a6e22e>any</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>args</span> <span style=color:#a6e22e>Args</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// extraction is done using pointers ONLY
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>extractInputs</span>(<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		    <span style=color:#75715e>// here we have the typed Args
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>out</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>args</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>WriteResponse</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>out</span>)
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>writeErrResp</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>extractorFor</span>(<span style=color:#a6e22e>argType</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Type</span>) <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>argType</span>.<span style=color:#a6e22e>Kind</span>() <span style=color:#f92672>!=</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Struct</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>PanicReasonHandlerExpectsAStruct</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>numFields</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>argType</span>.<span style=color:#a6e22e>NumField</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>funcs</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) <span style=color:#66d9ef>error</span>, <span style=color:#a6e22e>numFields</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>numFields</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>field</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>argType</span>.<span style=color:#a6e22e>Field</span>(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>PointerTo</span>(<span style=color:#a6e22e>field</span>.<span style=color:#a6e22e>Type</span>).<span style=color:#a6e22e>Implements</span>(<span style=color:#a6e22e>extType</span>) {
</span></span><span style=display:flex><span>			panic(<span style=color:#a6e22e>PanicReasonUnknownFieldType</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>funcs</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>extractFieldOfType</span>(<span style=color:#a6e22e>field</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>field</span>.<span style=color:#a6e22e>Offset</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// the returned function no longer takes Args, instead receives unsafe.Pointer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>argsPtr</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) (<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>funcs</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>n</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>funcs</span>[<span style=color:#a6e22e>i</span>](<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>argsPtr</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>WithStatusCode</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>extractFieldOfType</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fieldType</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>fieldOffset</span> <span style=color:#66d9ef>uintptr</span>,
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>argBasePtr</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fieldPtr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>argBasePtr</span>, <span style=color:#a6e22e>fieldOffset</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>field</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>NewAt</span>(<span style=color:#a6e22e>fieldType</span>, <span style=color:#a6e22e>fieldPtr</span>).<span style=color:#a6e22e>Interface</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>field</span>.(<span style=color:#a6e22e>Extractor</span>).<span style=color:#a6e22e>Extract</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=implementing-the-extractors>Implementing the Extractors<a href=#implementing-the-extractors class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Here come the fruits of our labor:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>JSON</span>[<span style=color:#a6e22e>Inner</span> <span style=color:#a6e22e>any</span>] <span style=color:#66d9ef>struct</span>{ <span style=color:#a6e22e>V</span> <span style=color:#a6e22e>Inner</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>v</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>JSON</span>[<span style=color:#a6e22e>T</span>]) <span style=color:#a6e22e>Extract</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>decodeBodyWith</span>(<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewDecoder</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>V</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Compare that to the <code>JSON</code> implementation in the previous post:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// cannot name the receiver here because it would be nil
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#f92672>*</span><span style=color:#a6e22e>JSON</span>[<span style=color:#a6e22e>T</span>]) <span style=color:#a6e22e>Extract</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) (<span style=color:#a6e22e>any</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>v</span> <span style=color:#a6e22e>JSON</span>[<span style=color:#a6e22e>T</span>] <span style=color:#75715e>// must allocate and return a new JSON here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>decodeBodyWith</span>(<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewDecoder</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>V</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// return type is any; if you return the wrong type
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// an angel loses its wings at runtime
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>The new one is more ergonomic, and free of pitfalls like this.</p><h2 id=finalizing-resources>Finalizing resources<a href=#finalizing-resources class=hanchor arialabel=Anchor>&#8983;</a></h2><p>There is one thing we didn&rsquo;t do: In our previous implementation, we gave <code>Extractors</code> a way to collect after them.
If the arguments of the function implemented <code>io.Closer</code>, we would call the <code>Close</code> functions at the end of handler.
We should do that here as well.</p><p>First, let&rsquo;s implement the <code>Logger</code> extractor so that we can see a use case:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Logger</span> <span style=color:#66d9ef>struct</span>{ <span style=color:#f92672>*</span><span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Logger</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Logger</span>) <span style=color:#a6e22e>Extract</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>Logger</span> = <span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Default</span>().<span style=color:#a6e22e>With</span>(<span style=color:#e6db74>&#34;route&#34;</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Path</span>, <span style=color:#e6db74>&#34;request_id&#34;</span>, <span style=color:#a6e22e>uuid</span>.<span style=color:#a6e22e>NewString</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;endpoint start&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Logger</span>) <span style=color:#a6e22e>Close</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>Logger</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;endpoint end&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If we run our previous &rsquo;test&rsquo;, we won&rsquo;t see the &ldquo;endpoint end&rdquo; log at the end of the handler:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestHandler</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mux</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewServeMux</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;POST /users&#34;</span>, <span style=color:#a6e22e>Handler</span>(<span style=color:#a6e22e>createUser</span>))
</span></span><span style=display:flex><span>	<span style=color:#75715e>// success case
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodPost</span>, <span style=color:#e6db74>&#34;/users&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#e6db74>`{&#34;username&#34;: &#34;abc&#34;}`</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>resp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>httptest</span>.<span style=color:#a6e22e>NewRecorder</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>ServeHTTP</span>(<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%d: %s\n&#34;</span>, <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Code</span>, <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>String</span>())
</span></span><span style=display:flex><span>	<span style=color:#75715e>// error case
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodPost</span>, <span style=color:#e6db74>&#34;/users&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#e6db74>`</span><span style=color:#75715e>{{</span><span style=color:#e6db74>`</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>resp</span> = <span style=color:#a6e22e>httptest</span>.<span style=color:#a6e22e>NewRecorder</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>ServeHTTP</span>(<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%d: %s\n&#34;</span>, <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Code</span>, <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>String</span>())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The output:</p><pre tabindex=0><code>2024/12/28 01:27:52 INFO endpoint start route=/users request_id=56601648-63ce-41db-8558-170c03440569
2024/12/28 01:27:52 INFO created route=/users request_id=56601648-63ce-41db-8558-170c03440569 user=abc
201: {&#34;id&#34;:1337,&#34;username&#34;:&#34;abc&#34;}

2024/12/28 01:27:52 INFO endpoint start route=/users request_id=7dd0031d-c7d5-41f1-96e8-2ed509e554bb
400: {&#34;error&#34;:&#34;invalid character &#39;{&#39; looking for beginning of object key string&#34;}
</code></pre><p>First of all; we want to check if each extracted field also implements <code>io.Closer</code>.
That means <code>extractFieldOfType</code> also returns this interface as well:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>extractFieldOfType</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fieldType</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>fieldOffset</span> <span style=color:#66d9ef>uintptr</span>,
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) (<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Closer</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>argBasePtr</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) (<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Closer</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fieldPtr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>argBasePtr</span>, <span style=color:#a6e22e>fieldOffset</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>field</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>NewAt</span>(<span style=color:#a6e22e>fieldType</span>, <span style=color:#a6e22e>fieldPtr</span>).<span style=color:#a6e22e>Interface</span>()
</span></span><span style=display:flex><span>		<span style=color:#75715e>// if field is also an io.Closer, cast that as well.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// if the cast fails; this will return nil anyway
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>closer</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>field</span>.(<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Closer</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>closer</span>, <span style=color:#a6e22e>field</span>.(<span style=color:#a6e22e>Extractor</span>).<span style=color:#a6e22e>Extract</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Since multiple fields can return as closers, we want to collect them so that we can call them all at once:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>closers</span> []<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Closer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>closers</span>) <span style=color:#a6e22e>Close</span>() (<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// iterate in reverse similar to defers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>c</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>--</span> {
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// this is cleanup; don&#39;t stop at the first error
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>c</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Close</span>())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then we use it in <code>extractorFor</code> like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>extractorFor</span>(<span style=color:#a6e22e>argType</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Type</span>) <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) (<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Closer</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// funcs now also return an optional io.Closer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>funcs</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) (<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Closer</span>, <span style=color:#66d9ef>error</span>), <span style=color:#a6e22e>numFields</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>numFields</span> {
</span></span><span style=display:flex><span>	    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>funcs</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>extractFieldOfType</span>(<span style=color:#a6e22e>field</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>field</span>.<span style=color:#a6e22e>Offset</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// since closer array also implements io.Closer; return it as one io.Closer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>argsPtr</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) (<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Closer</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> make(<span style=color:#a6e22e>closers</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>numFields</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>funcs</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>closer</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>(<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>argsPtr</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>WithStatusCode</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>closer</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			    <span style=color:#75715e>// collect all non-nil closers in the array
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>c</span> = append(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>closer</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Finally, we call this cleanup operation in the <code>Handler</code> after the endpoint is handled:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Handler</span>[<span style=color:#a6e22e>Args</span>, <span style=color:#a6e22e>Output</span> <span style=color:#a6e22e>any</span>](<span style=color:#a6e22e>handler</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>Args</span>) (<span style=color:#a6e22e>Output</span>, <span style=color:#66d9ef>error</span>)) <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandlerFunc</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>extractInputs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>extractorFor</span>(<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>TypeFor</span>[<span style=color:#a6e22e>Args</span>]())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>out</span> <span style=color:#a6e22e>any</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>args</span> <span style=color:#a6e22e>Args</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// cleanup operations are also returned here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>cleanup</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>extractInputs</span>(<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>out</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>args</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// cleanup here. doing this in a defer might be safer btw
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>cleanup</span>.<span style=color:#a6e22e>Close</span>())
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After this, we see the &ldquo;endpoint end&rdquo; logs as well:</p><pre tabindex=0><code>2024/12/28 01:42:09 INFO endpoint start route=/users request_id=6d481ca6-1917-46dc-9a6b-23b5e07398d3
2024/12/28 01:42:09 INFO created route=/users request_id=6d481ca6-1917-46dc-9a6b-23b5e07398d3 user=abc
2024/12/28 01:42:09 INFO endpoint end route=/users request_id=6d481ca6-1917-46dc-9a6b-23b5e07398d3
201: {&#34;id&#34;:1337,&#34;username&#34;:&#34;abc&#34;}

2024/12/28 01:42:09 INFO endpoint start route=/users request_id=cdf82e94-2f44-44ee-8a9a-e12d2cc85e76
2024/12/28 01:42:09 INFO endpoint end route=/users request_id=cdf82e94-2f44-44ee-8a9a-e12d2cc85e76
400: {&#34;error&#34;:&#34;invalid character &#39;{&#39; looking for beginning of object key string&#34;}
</code></pre><h2 id=final-notes>Final notes<a href=#final-notes class=hanchor arialabel=Anchor>&#8983;</a></h2><ul><li>Overall we ended up with a cleaner, safer and more performant design that is more readable in my opinion as well.</li><li>One change I did not mention here is the output type. In our example endpoint, we are now returning <code>User</code> directly
instead of <code>JSON[User]</code>. I was trying to closely imitate the axum API in the first post; but in general defaulting to
JSON serialization handles most cases anyway. If you want to return something else for an endpoint, simply implement
<code>Responder</code> on the return type. Writing this kind of logic in wrapper types instead complicates things for no reason.</li><li>One huge caveat in this implementation is <em>embedding</em> structs that contain <code>Extractors</code>. Remember that our
<code>extractorFor</code> function only iterates over the top-level fields; so if your function parameters look like this:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CreateUserParams</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Common</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>JSON</span>[<span style=color:#66d9ef>struct</span> {<span style=color:#f92672>...</span>}]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Common</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Logger</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>UserStore</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>createUser</span>(<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>CreateUserParams</span>) (<span style=color:#a6e22e>User</span>, <span style=color:#66d9ef>error</span>) { <span style=color:#f92672>...</span> }
</span></span></code></pre></div><p>Then the extractors in <code>Common</code> will not be resolved. The solution to this is largely out of scope for this blog post,
but you can either:</p><ol><li>Recurse into inner structs that don&rsquo;t implement <code>Extractor</code>, adding each level&rsquo;s field offset as well</li><li>Find a way to implement <code>Extractor</code> for <code>Common</code>, and delegate to inner fields</li></ol><ul><li><p>The order in which parameters are extracted is dependent on the order of fields in the struct.
This was also the case for our previous implementation. If somehow the order of these operations are important,
then instead of <em>returning</em> extractor functions you can pass a registry of functions where each extractor adds
itself. Then you add stages to the registry; and let each extractor also specify the order. That way extractors
can dictate the order of operations. I don&rsquo;t think this has many use cases.</p></li><li><p>The fields of the input struct are embedded in all examples, this is not a requirement. The version below works
equally well:</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>createUser</span>(<span style=color:#a6e22e>p</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span> <span style=color:#a6e22e>Logger</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>body</span> <span style=color:#a6e22e>JSON</span>[<span style=color:#a6e22e>CreateUser</span>]
</span></span><span style=display:flex><span>}) (<span style=color:#a6e22e>User</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;created&#34;</span>, <span style=color:#e6db74>&#34;user&#34;</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>V</span>.<span style=color:#a6e22e>Username</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>User</span>{<span style=color:#a6e22e>ID</span>: <span style=color:#ae81ff>1337</span>, <span style=color:#a6e22e>Username</span>: <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>V</span>.<span style=color:#a6e22e>Username</span>}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It is just more verbose.</p><ul><li><p>If you think that extractors may need other parameters than <code>*http.Request</code> for things like state, database etc.
you can add them to the interface. Or just (ab)use the request&rsquo;s <code>Context</code> to pass such things into the function.
I generally prefer the latter, using the <code>Context</code> for dependency injection lets you mock pretty much any external
dependency.</p></li><li><p>By the way, by tweaking the &lsquo;closer&rsquo; logic a little, you can manage even database transactions through <code>Extractor</code>s.
We piggybacked on the <code>io.Closer</code> interface, but if you write your own finisher interface that has two functions
(&ldquo;Run this one in case of success&rdquo;, &ldquo;Run this one in any situation&rdquo;) you can implement commit-rollback operations
in them.</p></li></ul><p>Thatâ€™s all I have for this post. Go now.</p><hr><p><a href=https://www.reddit.com/r/programming/comments/1hnrsqw/axumstyle_magic_handler_functions_in_go_part_2/>Discuss in r/programming</a>
| <a href=https://www.reddit.com/r/golang/comments/1hnryab/axumstyle_magic_handler_functions_in_go_part_2/>Discuss in r/golang</a></p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=/posts/go-axum-handlers/><span class=button__text>Axum-style Magic Handler Functions in Go, Part 1</span>
<span class=button__icon>â†’</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>Â© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/mirus-ua/hugo-theme-re-terminal target=_blank>Theme</a> made by <a href=https://github.com/mirus-ua target=_blank>Mirus</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>