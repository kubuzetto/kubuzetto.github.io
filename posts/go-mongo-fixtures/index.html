<!doctype html><html lang=en><head><title>Implementing MongoDB Test Fixtures in Go :: kubuzetto's blog</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Here is a way to load test fixtures for MongoDB in Go."><meta name=keywords content="go,mongodb,test"><meta name=robots content="noodp"><link rel=canonical href=/posts/go-mongo-fixtures/><link rel=stylesheet href=/styles.css><link rel="shortcut icon" href=/img/theme-colors/orange.png><link rel=apple-touch-icon href=/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Implementing MongoDB Test Fixtures in Go"><meta property="og:description" content="Here is a way to load test fixtures for MongoDB in Go."><meta property="og:url" content="/posts/go-mongo-fixtures/"><meta property="og:site_name" content="kubuzetto's blog"><meta property="og:image" content="/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2025-06-17 03:50:10 +0300 +0300"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>kubuzetto's blog</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/pages/about/>About</a></li><li><a href=/tags>Tags</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/pages/about/>About</a></li><li><a href=/tags>Tags</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/posts/go-mongo-fixtures/>Implementing MongoDB Test Fixtures in Go</a></h1><div class=post-meta><time class=post-date>2025-06-17</time></div><div class=table-of-contents><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a><ul><li><a href=#test-fixtures>Test fixtures</a></li><li><a href=#mongodb>MongoDB</a></li></ul></li><li><a href=#the-code>The code</a><ul><li><a href=#walking-the-directories>Walking the directories</a></li><li><a href=#loading-the-fixtures>Loading the fixtures</a></li><li><a href=#ejson-to-bson>EJSON to BSON</a></li></ul></li><li><a href=#testing-it>Testing it</a></li><li><a href=#the-hack-or-the-reason-i-wrote-a-blog-post>The hack (or, the reason I wrote a blog post)</a></li></ul></nav></div><div class=post-content><div><h2 id=introduction>Introduction<a href=#introduction class=hanchor arialabel=Anchor>&#8983;</a></h2><p>At some point in the recent past; I needed to port the integration tests of a Go service using PostgreSQL
to MongoDB. I was surprised by the lack of resources for loading test fixtures, so I decided to document
my approach here.</p><p>For PostgreSQL, we use <a href=https://github.com/go-testfixtures/testfixtures>go-testfixtures</a>
to describe our test data as <code>.yml</code> files, which (naturally) does not support MongoDB.
I wanted a similar approach for MongoDB.</p><h3 id=test-fixtures>Test fixtures<a href=#test-fixtures class=hanchor arialabel=Anchor>&#8983;</a></h3><p>In Ruby on Rails, applications with database access are tested using
<a href=https://guides.rubyonrails.org/testing.html#fixtures>test fixtures</a> described in YAML files.
Before the test, each table is populated with the data described in the corresponding YAML file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># test/fixtures/users.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>david</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>David Heinemeier Hansson</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>birthday</span>: <span style=color:#e6db74>1979-10-15</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>profession</span>: <span style=color:#ae81ff>Systems development</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>steve</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Steve Ross Kellock</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>birthday</span>: <span style=color:#e6db74>1974-09-27</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>profession</span>: <span style=color:#ae81ff>guy with keyboard</span>
</span></span></code></pre></div><p>This fixture will put two rows in the <code>users</code> table.</p><p><code>go-testfixtures</code> applies the same approach to Go:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>fixtures</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>testfixtures</span>.<span style=color:#a6e22e>New</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>testfixtures</span>.<span style=color:#a6e22e>Database</span>(<span style=color:#a6e22e>db</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>testfixtures</span>.<span style=color:#a6e22e>Dialect</span>(<span style=color:#e6db74>&#34;postgres&#34;</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>testfixtures</span>.<span style=color:#a6e22e>Paths</span>(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;fixtures/orders.yml&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;fixtures/customers.yml&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;common_fixtures/users&#34;</span>
</span></span><span style=display:flex><span>        ),
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>This will load the two files from the <code>fixtures/</code> directory, as well as any <code>.yml</code> files under the <code>users/</code> directory.
And this can be very useful for integration tests!</p><blockquote><p>I want to point out two things here.</p><p>First: one footgun with this approach is that the library <strong>wipes the entire database before
loading the fixture</strong>, so you need to make sure you&rsquo;re connected to the correct database.
This is easily solvable with the <code>testfixtures.DangerousSkipTestDatabaseCheck()</code> option, which
ensures that the database name contains <code>test</code>.</p><p>Secondly; if you&rsquo;re running queries against an actual database, you cannot parallelize DB-facing tests.
This is not specific to <code>go-testfixtures</code> and most organizations are fine with this situation; but if
you really need parallel testing, I&rsquo;ve seen the <a href=https://github.com/DATA-DOG/go-txdb>begin-query-rollback trick</a>
gain some traction lately.</p></blockquote><p><code>go-testfixtures</code> also supports templates, but we don&rsquo;t use this feature. What we <em>do</em> use is this though:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>id</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>created_at</span>: <span style=color:#ae81ff>now()</span> <span style=color:#75715e># or, more explicitly, RAW=NOW()</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>updated_at</span>: <span style=color:#ae81ff>now()</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ...</span>
</span></span></code></pre></div><p>PostgreSQL sees this and evaluates the <code>now()</code> query as the current timestamp. Passing raw queries like
this is super useful especially for things like timestamps that need not have a fixed value for the test.
I&rsquo;d like the same feature in my MongoDB fixture loader.</p><h3 id=mongodb>MongoDB<a href=#mongodb class=hanchor arialabel=Anchor>&#8983;</a></h3><p>MongoDB internally uses a binary format named BSON, but for compatibility reasons a JSON extension named
<a href=https://www.mongodb.com/docs/manual/reference/mongodb-extended-json/>Extended JSON</a> is also supported.</p><p>Extended JSON is valid JSON; but it also preserves things like type information more precisely.
<code>mongodb</code> tools like <code>mongoexport</code> all support Extended JSON.</p><blockquote><p>Now; you can directly
<a href=https://www.mongodb.com/resources/languages/json-to-mongodb>import Extended JSON documents</a>
into MongoDB using <code>mongoimport</code>, which is available in the <code>mongo-tools</code> package.
But since loading test fixtures is a simple job, and relying on the existence of an
external CLI tool, and spawning it for every test seems to be a little brittle to me.</p></blockquote><p>Cool. So, each collection will be a separate file. Since each collection can have multiple
documents, we should be able to represent multiple records. I can store the array of records
as a JSON array; but since JSON disallows trailing commas it would be slightly harder to keep tidy:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {<span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;david&#34;</span>},
</span></span><span style=display:flex><span>  {<span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;steve&#34;</span>},   <span style=color:#960050;background-color:#1e0010>&lt;-</span> <span style=color:#960050;background-color:#1e0010>syntax</span> <span style=color:#960050;background-color:#1e0010>error</span> <span style=color:#960050;background-color:#1e0010>here</span>, <span style=color:#960050;background-color:#1e0010>due</span> <span style=color:#960050;background-color:#1e0010>to</span> <span style=color:#960050;background-color:#1e0010>the</span> <span style=color:#960050;background-color:#1e0010>extra</span> <span style=color:#960050;background-color:#1e0010>comma</span> <span style=color:#960050;background-color:#1e0010>:(</span>
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>Instead, we can use the <a href=https://jsonlines.org/>JSON Lines</a> spec. It is basically multiple JSON
documents separated by a newline:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;david&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;steve&#34;</span>}
</span></span></code></pre></div><p>I&rsquo;m using JetBrains Goland as IDE, which has support for this if I set the extension to <code>.jsonl</code>.
Also, since Extended JSON is syntactically valid JSON, it is compatible with JSONL.</p><h2 id=the-code>The code<a href=#the-code class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Let&rsquo;s get cooking then. First, let&rsquo;s grab the mongo driver library:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>go get go.mongodb.org/mongo-driver
</span></span></code></pre></div><p>This is the only dependency we will need. Our <code>LoadMongoFixtures</code> function will receive a ref to the
<code>Database</code>, and a list of paths to load fixtures from:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>LoadMongoFixtures</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mongo</span>.<span style=color:#a6e22e>Database</span>, <span style=color:#a6e22e>paths</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// identify valid fixture files in the given paths
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>files</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>walkPaths</span>(<span style=color:#a6e22e>paths</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;cannot walk paths: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// for each file; load the fixture
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>files</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>loadOneMongoFixture</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>db</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>filePath</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>collection</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pair</span> <span style=color:#66d9ef>struct</span>{ <span style=color:#a6e22e>filePath</span>, <span style=color:#a6e22e>collection</span> <span style=color:#66d9ef>string</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>walkPaths</span>(<span style=color:#a6e22e>paths</span> []<span style=color:#66d9ef>string</span>) ([]<span style=color:#a6e22e>pair</span>, <span style=color:#66d9ef>error</span>) { <span style=color:#f92672>...</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>loadOneMongoFixture</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mongo</span>.<span style=color:#a6e22e>Database</span>, <span style=color:#a6e22e>filePath</span>, <span style=color:#a6e22e>collection</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>error</span> { <span style=color:#f92672>...</span> }
</span></span></code></pre></div><h3 id=walking-the-directories>Walking the directories<a href=#walking-the-directories class=hanchor arialabel=Anchor>&#8983;</a></h3><p><code>walkPaths</code> returns pairs of file path and collection name strings, which we iterate on and load one by one:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>walkPaths</span>(<span style=color:#a6e22e>paths</span> []<span style=color:#66d9ef>string</span>) ([]<span style=color:#a6e22e>pair</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>files</span> []<span style=color:#a6e22e>pair</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>paths</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// stat this path first to see if it&#39;s a file or a directory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>pathInfo</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stat</span>(<span style=color:#a6e22e>filePath</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;cannot stat file %q: %w&#34;</span>, <span style=color:#a6e22e>filePath</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// for files; directly append this as an entry
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>pathInfo</span>.<span style=color:#a6e22e>IsDir</span>() {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// if the file is explicitly added; don&#39;t check the extension
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>files</span> = append(<span style=color:#a6e22e>files</span>, <span style=color:#a6e22e>pair</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>filePath</span>:   <span style=color:#a6e22e>filePath</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>collection</span>: <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>SplitN</span>(<span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Base</span>(<span style=color:#a6e22e>filePath</span>), <span style=color:#e6db74>&#34;.&#34;</span>, <span style=color:#ae81ff>2</span>)[<span style=color:#ae81ff>0</span>],
</span></span><span style=display:flex><span>			})
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// for directories; we should read and iterate them
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>dirInfo</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>ReadDir</span>(<span style=color:#a6e22e>filePath</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;cannot stat dir %q: %w&#34;</span>, <span style=color:#a6e22e>filePath</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>files</span> = <span style=color:#a6e22e>walkDirs</span>(<span style=color:#a6e22e>filePath</span>, <span style=color:#a6e22e>dirInfo</span>, <span style=color:#a6e22e>files</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>files</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Nothing too fancy; if the path is a single file; we don&rsquo;t check the extension because it was explicitly added.
If it is a directory, we walk the dir and load files in it using <code>walkDirs</code>, which goes like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>walkDirs</span>(<span style=color:#a6e22e>p</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>dir</span> []<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>DirEntry</span>, <span style=color:#a6e22e>files</span> []<span style=color:#a6e22e>pair</span>) []<span style=color:#a6e22e>pair</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>file</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>dir</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// skip inner dirs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>IsDir</span>() {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// only process json / jsonl files
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>name</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Name</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ext</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Ext</span>(<span style=color:#a6e22e>name</span>); <span style=color:#a6e22e>ext</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;.jsonl&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>ext</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;.json&#34;</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// append the file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>files</span> = append(<span style=color:#a6e22e>files</span>, <span style=color:#a6e22e>pair</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>filePath</span>:   <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>name</span>),
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>collection</span>: <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>SplitN</span>(<span style=color:#a6e22e>name</span>, <span style=color:#e6db74>&#34;.&#34;</span>, <span style=color:#ae81ff>2</span>)[<span style=color:#ae81ff>0</span>],
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>files</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This one also checks for the file extension.</p><h3 id=loading-the-fixtures>Loading the fixtures<a href=#loading-the-fixtures class=hanchor arialabel=Anchor>&#8983;</a></h3><p>After this we actually load each fixture file using <code>loadOneMongoFixture</code>.
The first order of business is to open the file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>loadOneMongoFixture</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mongo</span>.<span style=color:#a6e22e>Database</span>, <span style=color:#a6e22e>filePath</span>, <span style=color:#a6e22e>collection</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// open the file for streaming
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#a6e22e>filePath</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;cannot open file %s: %w&#34;</span>, <span style=color:#a6e22e>filePath</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Close</span>() }()
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then we clear the collection:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#75715e>// clear the collection first
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Collection</span>(<span style=color:#a6e22e>collection</span>).<span style=color:#a6e22e>DeleteMany</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>M</span>{}); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;cannot clear collection %s: %w&#34;</span>, <span style=color:#a6e22e>collection</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>OK, time to read some JSON lines! Unlike <code>json.Unmarshal</code>, <code>json.NewDecoder</code> allows trailing
tokens in the stream unless explicitly checked against; so we can simply loop with it until <code>.More()</code> returns false.
This is better than splitting from newlines; because we actually don&rsquo;t want <em>lines</em> of JSON:
A JSON record can have newlines in it due to formatting. What we actually want is JSON after JSON, basically:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#75715e>// stream the file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>dec</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>file</span>); <span style=color:#a6e22e>dec</span>.<span style=color:#a6e22e>More</span>(); { <span style=color:#f92672>...</span> }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now is the time to slow down because the boilerplate is over: we are getting into the business logic here.</p><h3 id=ejson-to-bson>EJSON to BSON<a href=#ejson-to-bson class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Inside that loop, we should first read one record of Extended JSON, then convert it to BSON.</p><p>Since EJSON is syntactically valid JSON; we can use the JSON decoder to obtain the boundaries of the message like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>		<span style=color:#75715e>// first, decode into a RawMessage. this is necessary only to identify the boundaries of one entry
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>raw</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>RawMessage</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>dec</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>raw</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;cannot decode fixture %s: %w&#34;</span>, <span style=color:#a6e22e>collection</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span></code></pre></div><p>This reads one JSON record worth of data into a <code>json.RawMessage</code> chunk, which is <code>[]byte</code> basically.
At this point, we had split off one record from an array of EJSON records. Now, we can pass this slice
of bytes to <code>bson.UnmarshalExtJSON</code> to obtain a <code>bson.M</code> map object, which is the actual unmarshalling step:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>		<span style=color:#75715e>// now; using the raw message as the input; parse the json into a bson map
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>doc</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>M</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>UnmarshalExtJSON</span>(<span style=color:#a6e22e>raw</span>, <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>doc</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;cannot unmarshal fixture %s: %w&#34;</span>, <span style=color:#a6e22e>collection</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span></code></pre></div><p>MongoDB here we come!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Collection</span>(<span style=color:#a6e22e>collection</span>).<span style=color:#a6e22e>InsertOne</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>doc</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;cannot insert document to collection %s: %w&#34;</span>, <span style=color:#a6e22e>collection</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span></code></pre></div><h2 id=testing-it>Testing it<a href=#testing-it class=hanchor arialabel=Anchor>&#8983;</a></h2><p>We need to test this. First, some helpers:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>testDB</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mongo</span>.<span style=color:#a6e22e>Database</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestMain</span>(<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>M</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cli</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mongo</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Client</span>().<span style=color:#a6e22e>ApplyURI</span>(<span style=color:#e6db74>&#34;mongodb://localhost:27017&#34;</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>testDB</span> = <span style=color:#a6e22e>cli</span>.<span style=color:#a6e22e>Database</span>(<span style=color:#e6db74>&#34;example&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Run</span>())
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>assertEq</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>expected</span>, <span style=color:#a6e22e>actual</span> <span style=color:#a6e22e>any</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Helper</span>(); <span style=color:#a6e22e>expected</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>actual</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;assertion failed (expected: %v, actual: %v)&#34;</span>, <span style=color:#a6e22e>expected</span>, <span style=color:#a6e22e>actual</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>TestMain</code> sets up our database connection. I hardcoded the database config because
this is a blog post, cut me some slack here ok? I also threw in <code>assertEq</code> for shorter code later.</p><p>Let&rsquo;s write a test:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Post</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Title</span>       <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`bson:&#34;title&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PublishedAt</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span> <span style=color:#e6db74>`bson:&#34;published_at&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestLoadFixtures</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Context</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>LoadMongoFixtures</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>testDB</span>, <span style=color:#e6db74>&#34;fixtures/&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>assertEq</span>(<span style=color:#a6e22e>t</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>testDB</span>.<span style=color:#a6e22e>Collection</span>(<span style=color:#e6db74>&#34;posts&#34;</span>).<span style=color:#a6e22e>Find</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>D</span>{})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>assertEq</span>(<span style=color:#a6e22e>t</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>records</span> []<span style=color:#a6e22e>Post</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>assertEq</span>(<span style=color:#a6e22e>t</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>All</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>records</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>assertEq</span>(<span style=color:#a6e22e>t</span>, <span style=color:#ae81ff>2</span>, len(<span style=color:#a6e22e>records</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Ok, we simply load the mongo fixtures under the <code>fixtures/</code> path; then read all entries
in the <code>posts</code> collection and decode them in an array of <code>Post</code>s.</p><p>Here is our test fixture for this test; <code>fixtures/posts.jsonl</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;Hello world!&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;published_at&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;$dateSubtract&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;startDate&#34;</span>: <span style=color:#e6db74>&#34;$$NOW&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;unit&#34;</span>: <span style=color:#e6db74>&#34;minute&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;amount&#34;</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;Hello again!&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;published_at&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;$dateSubtract&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;startDate&#34;</span>: <span style=color:#e6db74>&#34;$$NOW&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;unit&#34;</span>: <span style=color:#e6db74>&#34;minute&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;amount&#34;</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>All we need to do is to spin up a local Mongo instance and run the test.</p><p>See how we wrote those &ldquo;now minus 5 minutes&rdquo; kind of timestamps? Isn&rsquo;t that cool that MongoDB supports th-</p><pre tabindex=0><code>=== RUN   TestLoadFixtures
    fixture_test.go:44: assertion failed (expected: &lt;nil&gt;, actual: error decoding key published_at: cannot decode embedded document into a time.Time)
--- FAIL: TestLoadFixtures (0.01s)
</code></pre><h2 id=the-hack-or-the-reason-i-wrote-a-blog-post>The hack (or, the reason I wrote a blog post)<a href=#the-hack-or-the-reason-i-wrote-a-blog-post class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Ok ummm I may have celebrated prematurely. Apparently, Mongo Compass evaluates this, so does <code>mongoimport</code>; but
when you use the insert flow it is treated as a dictionary as-is.</p><p>Fortunately, there is a catch! <code>UpdateOne</code> actually <em>does</em> evaluate expressions in the updated
documents when passed a pipeline. This allows us to pass things like dynamic timestamps using <code>$currentDate</code>.</p><p>However, we want to <em>insert</em> documents, not <em>update</em> them. Well, how about we do an upsert,
provide an impossible-to-match filter to it, so it never matches, therefore it always behaves as an insert.</p><p>Since all documents in Mongo have an <code>_id</code> field, we can check for its absence.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>		<span style=color:#75715e>// replacing the InsertOne with this
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Collection</span>(<span style=color:#a6e22e>collection</span>).<span style=color:#a6e22e>UpdateOne</span>(<span style=color:#a6e22e>ctx</span>,
</span></span><span style=display:flex><span>			<span style=color:#75715e>// &#34;update the documents without an _id field&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>M</span>{<span style=color:#e6db74>&#34;_id&#34;</span>: <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>M</span>{<span style=color:#e6db74>&#34;$exists&#34;</span>: <span style=color:#66d9ef>false</span>}},
</span></span><span style=display:flex><span>			<span style=color:#75715e>// this has to be an array for it to be considered a pipeline
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			[]<span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>M</span>{{<span style=color:#e6db74>&#34;$set&#34;</span>: <span style=color:#a6e22e>doc</span>}},
</span></span><span style=display:flex><span>			<span style=color:#75715e>// setUpsert lets us abuse this to behave as an insert
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Update</span>().<span style=color:#a6e22e>SetUpsert</span>(<span style=color:#66d9ef>true</span>),
</span></span><span style=display:flex><span>		); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;cannot insert document to collection %s: %w&#34;</span>, <span style=color:#a6e22e>collection</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span></code></pre></div><p>When we run it again the test passes!</p><pre tabindex=0><code>=== RUN   TestLoadFixtures
--- PASS: TestLoadFixtures (0.01s)
</code></pre><p>If we add extra assertions, we see that the timestamps are correctly evaluated.</p><p>That&rsquo;s all I have for tonight. Go now.</p><hr></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/go-partial-on-conflict/><span class=button__icon>←</span>
<span class=button__text>Writing ON CONFLICT Clauses on Partial Indexes using GORM</span>
</a></span><span class="button next"><a href=/posts/go-deser-dispatch/><span class=button__text>Automatic Go Union Deserialization Dispatch with Tags</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/mirus-ua/hugo-theme-re-terminal target=_blank>Theme</a> made by <a href=https://github.com/mirus-ua target=_blank>Mirus</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>